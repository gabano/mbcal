<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Middle Years - Maple Bear</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mb-blue: #004a99; --mb-red: #e30613; }
        body { font-family: 'Inter', sans-serif; }
        
        /* Room Timeline Styling */
        .timeline-wrapper { overflow-x: auto; white-space: nowrap; background: #fff; padding: 15px; border-radius: 12px; }
        .time-axis { display: flex; margin-left: 100px; border-bottom: 1px solid #eee; }
        .time-tick { min-width: 50px; font-size: 10px; color: #999; text-align: left; }
        .room-row { display: flex; align-items: center; margin-top: 10px; }
        .room-label { min-width: 100px; font-weight: bold; font-size: 11px; color: var(--mb-blue); }
        .room-bar { flex-grow: 1; height: 20px; background: #f0fdf4; border-radius: 10px; position: relative; min-width: 566px; border: 1px solid #dcfce7; }
        .busy-block-room { position: absolute; height: 100%; background: #fee2e2; border-left: 3px solid var(--mb-red); font-size: 9px; display: flex; align-items: center; padding-left: 4px; color: #b91c1c; }

        /* Day Containers */
        .day-container { background: white; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 8px solid var(--mb-blue); overflow: hidden; }
        .event-slot { transition: all 0.2s; border-left: 4px solid #cbd5e1; }
        .event-slot:active { transform: scale(0.98); background-color: #f1f5f9; }
        
        /* Modal Scroll */
        .modal-content::-webkit-scrollbar { width: 4px; }
        .modal-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 pb-32 px-4 pt-4">

    <div class="max-w-4xl mx-auto mb-8">
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
            <h2 class="text-xs font-black uppercase mb-3 text-gray-400 tracking-widest">Ocupação das Salas (Hoje)</h2>
            <div class="timeline-wrapper">
                <div class="time-axis" id="timeAxis"></div>
                <div class="room-row"><span class="room-label">Reunião</span><div class="room-bar" id="bar-Sala de Reunião"></div></div>
                <div class="room-row"><span class="room-label">Direção</span><div class="room-bar" id="bar-Sala da Direção"></div></div>
                <div class="room-row"><span class="room-label">Aula</span><div class="room-bar" id="bar-Sala de aula"></div></div>
            </div>
        </div>
    </div>

    <div id="days-wrapper" class="max-w-4xl mx-auto space-y-4">
        <div class="text-center py-10 text-gray-400">Carregando agenda...</div>
    </div>

    <button onclick="toggleModal(true)" class="fixed bottom-8 right-8 bg-red-600 text-white w-16 h-16 rounded-full shadow-2xl text-4xl font-light flex items-center justify-center z-50 transition-transform active:scale-90">＋</button>

    <div id="modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden">
            <div class="p-6 overflow-y-auto max-h-[85vh] modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-blue-900">Novo Agendamento</h2>
                    <button onclick="toggleModal(false)" class="text-gray-400 hover:text-black text-2xl">✕</button>
                </div>
                
                <form id="scheduleForm" class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Informações do Aluno</label>
                        <input type="text" id="nomeAluno" placeholder="Nome Completo" required class="w-full bg-gray-50 border-none p-4 rounded-2xl focus:ring-2 focus:ring-blue-900 outline-none">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Data</label>
                            <input type="date" id="data" required class="w-full bg-gray-50 border-none p-4 rounded-2xl outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Início (60min)</label>
                            <input type="time" id="hora" min="07:00" max="18:20" required class="w-full bg-gray-50 border-none p-4 rounded-2xl outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Segmento</label>
                            <select id="segmento" onchange="updateTurmas()" class="w-full bg-gray-50 border-none p-4 rounded-2xl outline-none appearance-none">
                                <option>ECE</option><option>ELE</option><option selected>MY</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Turma</label>
                            <select id="turma" class="w-full bg-gray-50 border-none p-4 rounded-2xl outline-none appearance-none"></select>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Local da Reunião</label>
                        <select id="local" class="w-full bg-gray-50 border-none p-4 rounded-2xl outline-none appearance-none">
                            <option>Sala de Reunião</option><option>Sala da Direção</option><option>Sala de aula</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Tema Principal</label>
                        <select id="tema" class="w-full bg-gray-50 border-none p-4 rounded-2xl outline-none appearance-none">
                            <option>Comportamental</option><option>Desenvolvimento Acadêmico</option><option>Reunião Interna</option><option>CoC</option><option>Acompanhamento Externo</option><option>PEI</option><option>Reclamação</option><option>Aluno Novo</option><option>Outros</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4 pt-2">
                        <select id="psicologa" class="bg-gray-100 p-3 rounded-xl text-sm border-none outline-none"><option>Ana Lídia</option><option>Vanessa</option></select>
                        <select id="solicitante" class="bg-gray-100 p-3 rounded-xl text-sm border-none outline-none"><option>Escola</option><option>Família</option><option>Profissionais</option></select>
                    </div>

                    <textarea id="detalhes" placeholder="Observações adicionais..." class="w-full bg-gray-50 border-none p-4 rounded-2xl outline-none h-24 resize-none"></textarea>

                    <button type="submit" id="submitBtn" class="w-full bg-blue-900 text-white font-black py-5 rounded-2xl shadow-lg hover:bg-blue-800 transition-colors mt-4">CONFIRMAR AGENDAMENTO</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2lrYJmIYnkIeLYbr6xuQmQXrG4bCpjIGU49sOENWqXVJHgA6Bj54h61BX-AISpIej/exec';
        
        function toggleModal(show) { document.getElementById('modal').classList.toggle('hidden', !show); }

        function updateTurmas() {
            const seg = document.getElementById('segmento').value;
            const data = {
                'ECE': ['JK.M', 'JK.T', 'NUR.M', 'NUR.T', 'SK.M', 'SK.T', 'TOD.M', 'TOD.T'],
                'ELE': ['Y1.M', 'Y1.T', 'Y2.M', 'Y2.T', 'Y3.M', 'Y3.T', 'Y4.M', 'Y4.T'],
                'MY': ['Y6A', 'Y6B', 'Y7A', 'Y7B', 'Y8', 'Y9']
            };
            document.getElementById('turma').innerHTML = data[seg].map(t => `<option>${t}</option>`).join('');
        }

        async function loadData() {
            try {
                const res = await fetch(SCRIPT_URL);
                const events = await res.json();
                renderContainers(events);
                updateRoomVisuals(events);
            } catch (e) {
                console.error("Erro ao carregar dados:", e);
            }
        }

        function renderContainers(events) {
            const wrapper = document.getElementById('days-wrapper');
            const weekdays = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta'];
            wrapper.innerHTML = '';

            weekdays.forEach((day, index) => {
                const container = document.createElement('div');
                container.className = 'day-container p-6';
                
                // Filter events for this weekday (Mon=1 ... Fri=5)
                const dayEvents = events.filter(e => new Date(e.start).getDay() === index + 1);
                dayEvents.sort((a,b) => new Date(a.start) - new Date(b.start));

                container.innerHTML = `<h3 class="text-xl font-black text-blue-900 mb-6 flex justify-between items-center">${day} <span class="text-[10px] text-gray-300 font-normal">07:00 - 18:20</span></h3>`;
                
                if(dayEvents.length === 0) {
                    container.innerHTML += `<div class="py-4 text-center border-2 border-dashed border-gray-100 rounded-2xl text-gray-300 text-xs font-bold uppercase tracking-widest">Sala Livre</div>`;
                } else {
                    dayEvents.forEach(e => {
                        const time = new Date(e.start).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                        const segMatch = e.description?.match(/Segmento:\s*(.*)/);
                        const segmento = segMatch ? segMatch[1] : "---";

                        const slot = document.createElement('div');
                        slot.className = "event-slot bg-gray-50 p-4 mb-3 rounded-2xl shadow-sm cursor-pointer hover:border-blue-500";
                        slot.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span class="font-black text-blue-900 text-lg">${time}</span>
                                <span class="text-[9px] font-mono text-gray-300 uppercase">ID: ...${e.id.slice(-6)}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                                <span class="text-sm font-bold text-gray-700">OCUPADO • <span class="text-blue-600">${segmento}</span></span>
                            </div>
                        `;
                        slot.onclick = () => manageEventStatus(e.id);
                        container.appendChild(slot);
                    });
                }
                wrapper.appendChild(container);
            });
        }

   async function manageEventStatus(eventId) {
    const pwd = prompt("Senha de Coordenador:");
    if (pwd !== "cancelar123") return;

    const menu = "O que deseja fazer?\n1. Marcar CONFIRMADA (Verde)\n2. Marcar NO SHOW (Preto)\n3. Marcar CANCELADA (Vermelho)\n4. EXCLUIR do Google Calendar";
    const choice = prompt(menu);
    
    let payload = { eventId: eventId };

    if (choice === "1") { payload.action = 'updateStatus'; payload.newStatus = 'Confirmada'; }
    else if (choice === "2") { payload.action = 'updateStatus'; payload.newStatus = 'No show'; }
    else if (choice === "3") { payload.action = 'updateStatus'; payload.newStatus = 'Cancelada'; }
    else if (choice === "4") { 
        if(confirm("Tem certeza que deseja apagar o evento do Google Calendar?")) {
            payload.action = 'delete';
        } else return;
    } else return;

    const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
    });
    
    const result = await res.json();
    if (result.success) {
        alert("Sincronizado com Google Calendar!");
        location.reload();
    }
}

        function updateRoomVisuals(events) {
            const today = new Date().toISOString().split('T')[0];
            const startDay = 7; 
            const totalHours = 11.33; // 7h to 18h20
            
            ['Sala de Reunião', 'Sala da Direção', 'Sala de aula'].forEach(room => {
                const bar = document.getElementById(`bar-${room}`);
                if(!bar) return;
                bar.innerHTML = '';
                events.filter(e => e.start.startsWith(today) && e.location === room).forEach(e => {
                    const s = new Date(e.start);
                    const eTime = new Date(e.end);
                    const left = ((s.getHours() + s.getMinutes()/60) - startDay) / totalHours * 100;
                    const width = (eTime - s) / (totalHours * 3600000) * 100;
                    bar.innerHTML += `<div class="busy-block-room" style="left:${left}%; width:${width}%"></div>`;
                });
            });
        }

        document.getElementById('scheduleForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "PROCESSANDO...";
            btn.disabled = true;

            const payload = {
                action: 'create',
                nomeAluno: document.getElementById('nomeAluno').value,
                start: `${document.getElementById('data').value}T${document.getElementById('hora').value}:00`,
                turma: document.getElementById('turma').value,
                segmento: document.getElementById('segmento').value,
                tema: document.getElementById('tema').value,
                local: document.getElementById('local').value,
                psicologa: document.getElementById('psicologa').value,
                solicitante: document.getElementById('solicitante').value,
                detalhes: document.getElementById('detalhes').value
            };

            const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await response.json();
            
            if(result.success) {
                alert("Agendamento realizado!");
                location.reload();
            } else {
                alert("ERRO: " + result.error);
                btn.innerText = "CONFIRMAR AGENDAMENTO";
                btn.disabled = false;
            }
        };

        // UI Setup
        const axis = document.getElementById('timeAxis');
        for(let h=7; h<=18; h++) axis.innerHTML += `<div class="time-tick">${h}:00</div>`;
        updateTurmas();
        loadData();
    </script>
</body>
</html>
