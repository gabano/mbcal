<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maple Bear - Agenda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mb-brand: #990b02; }
        body { font-family: ui-sans-serif, system-ui, sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .day-card { background: white; border-radius: 24px; border-left: 10px solid var(--mb-brand); margin-bottom: 2rem; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); }
        
        /* Cores de Status */
        .status-confirmada { border-left-color: #22c55e; background: #f0fdf4; }
        .status-noshow { border-left-color: #4b5563; background: #f3f4f6; }
        .status-cancelada { border-left-color: #ef4444; background: #fef2f2; }
        .status-aconfirmar { border-left-color: #3b82f6; background: #eff6ff; }
        
        .key-btn { width: 72px; height: 72px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 50%; font-size: 1.5rem; font-weight: 800; color: var(--mb-brand); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .key-btn:active { transform: scale(0.9); background-color: #f1f1f1; }
        .room-bar { height: 12px; background: #e2e8f0; border-radius: 6px; position: relative; min-width: 500px; }
        .busy-now { position: absolute; height: 100%; background: var(--mb-brand); border-radius: 4px; }
    </style>
</head>
<body class="p-4 pb-32">

    <div id="auth-overlay" class="fixed inset-0 bg-[#990b02] z-[300] flex flex-col items-center justify-center p-6 text-white">
        <div class="text-center mb-8">
            <div class="text-5xl mb-4">üîê</div>
            <h1 class="text-xl font-black uppercase tracking-widest">Acesso Restrito</h1>
            <div id="pass-display" class="flex gap-4 justify-center mt-6 h-4">
                <div class="w-3 h-3 rounded-full border-2 border-white"></div>
                <div class="w-3 h-3 rounded-full border-2 border-white"></div>
                <div class="w-3 h-3 rounded-full border-2 border-white"></div>
                <div class="w-3 h-3 rounded-full border-2 border-white"></div>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-6">
            <script> [1,2,3,4,5,6,7,8,9].forEach(n => document.write(`<button class="key-btn" onclick="press('${n}')">${n}</button>`)); </script>
            <div class="flex items-center justify-center text-white/50 cursor-pointer" onclick="resetPass()">‚úï</div>
            <button class="key-btn" onclick="press('0')">0</button>
            <div class="flex items-center justify-center text-white/50 cursor-pointer" onclick="backspace()">‚å´</div>
        </div>
    </div>

    <div class="max-w-2xl mx-auto bg-white p-6 rounded-[32px] shadow-sm mb-10 border border-slate-100">
        <h2 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-[0.2em]">Ocupa√ß√£o Hoje</h2>
        <div class="overflow-x-auto">
            <div class="flex ml-20 mb-2" id="timeLabels"></div>
            <div class="space-y-4">
                <div class="flex items-center gap-4"><span class="text-[10px] font-black w-16 text-slate-500">REUNI√ÉO</span><div class="room-bar flex-1" id="bar-Sala de Reuni√£o"></div></div>
                <div class="flex items-center gap-4"><span class="text-[10px] font-black w-16 text-slate-500">DIRE√á√ÉO</span><div class="room-bar flex-1" id="bar-Sala da Dire√ß√£o"></div></div>
                <div class="flex items-center gap-4"><span class="text-[10px] font-black w-16 text-slate-500">AULA</span><div class="room-bar flex-1" id="bar-Sala de aula"></div></div>
            </div>
        </div>
    </div>

    <div id="agenda-feed" class="max-w-2xl mx-auto space-y-6"></div>

    <button onclick="document.getElementById('createModal').classList.remove('hidden')" class="fixed bottom-8 right-8 bg-[#990b02] text-white w-16 h-16 rounded-full shadow-2xl text-4xl flex items-center justify-center z-50 transition-transform active:scale-90">Ôºã</button>

    <div id="createModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto shadow-2xl">
            <form id="scheduleForm" class="space-y-4">
                <h2 class="text-2xl font-black text-[#990b02] mb-4 uppercase tracking-tighter">Novo Agendamento</h2>
                <input type="text" id="nomeAluno" placeholder="Nome do Aluno" required class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-[#990b02]">
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="form-data" required class="bg-slate-50 p-4 rounded-2xl outline-none">
                    <input type="time" id="form-hora" required class="bg-slate-50 p-4 rounded-2xl outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <select id="segmento" onchange="updateTurmas()" class="bg-slate-50 p-4 rounded-2xl outline-none"><option>ECE</option><option>ELE</option><option selected>MY</option></select>
                    <select id="turma" class="bg-slate-50 p-4 rounded-2xl outline-none"></select>
                </div>
                <select id="psicologa" class="w-full bg-slate-50 p-4 rounded-2xl outline-none"><option value="N√£o">Psic√≥loga: N√£o</option><option value="Ana L√≠dia">Ana L√≠dia</option><option value="Vanessa">Vanessa</option></select>
                <select id="local" class="w-full bg-slate-50 p-4 rounded-2xl outline-none"><option>Sala de Reuni√£o</option><option>Sala da Dire√ß√£o</option><option>Sala de aula</option></select>
                <button type="submit" id="btn-submit" class="w-full bg-[#990b02] text-white font-black py-5 rounded-2xl shadow-lg mt-2 flex justify-center items-center">
                    <span id="btn-text">CRIAR AGENDAMENTO</span>
                </button>
                <button type="button" onclick="document.getElementById('createModal').classList.add('hidden')" class="w-full text-slate-400 font-bold py-2">Voltar</button>
            </form>
        </div>
    </div>

    <div id="actionModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-end sm:items-center justify-center p-4">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-md p-8 shadow-2xl text-center">
            <h3 class="text-xl font-black text-[#990b02] mb-6">A√ß√µes do Evento</h3>
            <div class="grid gap-3">
                <button onclick="updateStatus('Confirmada')" class="bg-green-500 text-white py-4 rounded-2xl font-bold">Confirmada</button>
                <button onclick="updateStatus('No show')" class="bg-gray-600 text-white py-4 rounded-2xl font-bold">No Show</button>
                <button onclick="updateStatus('Cancelada')" class="bg-red-500 text-white py-4 rounded-2xl font-bold">Cancelada</button>
                <button onclick="deleteEvent()" class="bg-black text-white py-2 rounded-xl text-[10px] mt-4 uppercase font-bold tracking-widest">Excluir Registro</button>
                <button onclick="document.getElementById('actionModal').classList.add('hidden')" class="text-slate-400 mt-2 font-bold">Voltar</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMgUB-eAgzhrq9PFAZB-6ZYRa8J5Kgowt7j4pcbJMgaIsP6vHMPZLzEcyJzDMN3d2TkQ/exec';
        let currentEventId = null;
        let inputPass = "";
        let sessionHash = sessionStorage.getItem('mb_auth_hash');

        if (sessionHash === "5067") { document.getElementById('auth-overlay').style.display = 'none'; }

        function press(val) {
            if(inputPass.length >= 4) return;
            inputPass += val;
            updateDisplay();
            if(inputPass.length === 4) {
                if(inputPass === "5067") {
                    sessionStorage.setItem('mb_auth_hash', inputPass);
                    sessionHash = inputPass;
                    document.getElementById('auth-overlay').style.display = 'none';
                } else { alert("Senha Incorreta"); resetPass(); }
            }
        }
        function updateDisplay() {
            const dots = document.querySelectorAll('#pass-display div');
            dots.forEach((dot, i) => i < inputPass.length ? dot.classList.add('bg-white') : dot.classList.remove('bg-white'));
        }
        function resetPass() { inputPass = ""; updateDisplay(); }
        function backspace() { inputPass = inputPass.slice(0, -1); updateDisplay(); }

        async function load() {
            const res = await fetch(SCRIPT_URL);
            const events = await res.json();
            const feed = document.getElementById('agenda-feed');
            feed.innerHTML = '';
            const today = new Date();
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

            for(let i = 0; i < 40; i++) {
                const d = new Date();
                d.setDate(today.getDate() + i);
                if(d.getDay() === 0 || d.getDay() === 6) continue;
                const dateStr = d.toISOString().split('T')[0];
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card p-6';
                dayCard.innerHTML = `<div class="mb-4 border-b pb-2"><h3 class="text-xl font-black text-[#990b02] uppercase">${d.toLocaleDateString('pt-BR', {weekday:'long'})}</h3><p class="text-[10px] font-bold text-slate-400">${d.getDate()} de ${monthNames[d.getMonth()]} de ${d.getFullYear()}</p></div>`;
                
                // ORDENA√á√ÉO CRONOL√ìGICA (MAIS CEDO PARA MAIS TARDE)
                const dayEvents = events.filter(e => e.start.startsWith(dateStr))
                                        .sort((a,b) => new Date(a.start) - new Date(b.start));

                dayEvents.forEach(e => {
                    const time = new Date(e.start).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                    dayCard.innerHTML += `<div onclick="handleEventClick('${e.id}')" class="p-4 mb-3 rounded-2xl shadow-sm cursor-pointer transition-all active:scale-95 status-${e.status.toLowerCase().replace(" ", "")}"><div class="flex justify-between items-center"><span class="font-black text-lg">${time}</span><span class="text-[8px] font-bold uppercase opacity-40">${e.status}</span></div><div class="text-sm font-bold text-slate-700">${e.title}</div></div>`;
                });
                feed.appendChild(dayCard);
            }
            updateRoomVisuals(events);
        }

        function handleEventClick(id) { currentEventId = id; document.getElementById('actionModal').classList.remove('hidden'); }
        async function updateStatus(s) {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', eventId: currentEventId, newStatus: s, authHash: sessionHash })});
            location.reload();
        }
        async function deleteEvent() {
            if(confirm("Excluir definitivamente?")) {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', eventId: currentEventId, authHash: sessionHash })});
                location.reload();
            }
        }
        function updateRoomVisuals(events) {
            const todayStr = new Date().toISOString().split('T')[0];
            ['Sala de Reuni√£o', 'Sala da Dire√ß√£o', 'Sala de aula'].forEach(room => {
                const bar = document.getElementById(`bar-${room}`);
                if(!bar) return;
                bar.innerHTML = '';
                events.filter(e => e.start.startsWith(todayStr) && e.location === room).forEach(e => {
                    const s = new Date(e.start); const eTime = new Date(e.end);
                    const left = ((s.getHours() + s.getMinutes()/60) - 7) / 11.33 * 100;
                    const width = (eTime - s) / (11.33 * 3600000) * 100;
                    bar.innerHTML += `<div class="busy-now" style="left:${left}%; width:${width}%"></div>`;
                });
            });
        }
        function updateTurmas() {
            const seg = document.getElementById('segmento').value;
            const data = { 'ECE': ['JK.M', 'JK.T', 'NUR.M', 'NUR.T', 'SK.M', 'SK.T', 'TOD.M', 'TOD.T'], 'ELE': ['Y1.M', 'Y1.T', 'Y2.M', 'Y2.T', 'Y3.M', 'Y3.T', 'Y4.M', 'Y4.T'], 'MY': ['Y6A', 'Y6B', 'Y7A', 'Y7B', 'Y8', 'Y9'] };
            document.getElementById('turma').innerHTML = data[seg].map(t => `<option>${t}</option>`).join('');
        }
        
        document.getElementById('scheduleForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-submit');
    const btnText = document.getElementById('btn-text');
    
    btn.disabled = true;
    btnText.innerText = "CONECTANDO...";

    const payload = { 
        action: 'create', 
        nomeAluno: document.getElementById('nomeAluno').value, 
        start: `${document.getElementById('form-data').value}T${document.getElementById('form-hora').value}:00`, 
        turma: document.getElementById('turma').value, 
        segmento: document.getElementById('segmento').value, 
        psicologa: document.getElementById('psicologa').value, 
        local: document.getElementById('local').value,
        authHash: sessionHash
    };

    try {
        // Usamos o m√©todo 'sendBeacon' ou um fetch simplificado para evitar travamentos de CORS no POST
        await fetch(SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', // Isso evita que o navegador bloqueie o envio direto ao Google
            body: JSON.stringify(payload) 
        });

        btnText.innerText = "SUCESSO!";
        setTimeout(() => {
            alert("Agendamento enviado! O calend√°rio atualizar√° em instantes.");
            location.reload();
        }, 1000);

    } catch (err) {
        alert("Erro ao enviar. Tente novamente.");
        btn.disabled = false;
        btnText.innerText = "CRIAR AGENDAMENTO";
    }
};
            
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(p) });
            setTimeout(() => { alert("Agendamento conclu√≠do!"); location.reload(); }, 1500);
        };

        for(let i=7;i<=18;i++) document.getElementById('timeLabels').innerHTML += `<span class="min-w-[40px] text-[10px] text-slate-300 font-bold">${i}h</span>`;
        updateTurmas(); load();
    </script>
</body>
</html>
