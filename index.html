<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maple Bear - Middle Years</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mb-brand: #990b02; --mb-bg: #f8fafc; }
        body { font-family: ui-sans-serif, system-ui, sans-serif; -webkit-tap-highlight-color: transparent; background-color: var(--mb-bg); }
        
        /* Estiliza√ß√£o Customizada */
        .day-card { background: white; border-radius: 24px; border-left: 10px solid var(--mb-brand); margin-bottom: 2rem; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); }
        .status-confirmada { border-left-color: #22c55e; background: #f0fdf4; }
        .status-noshow { border-left-color: #4b5563; background: #f3f4f6; }
        .status-cancelada { border-left-color: #ef4444; background: #fef2f2; }
        .status-aconfirmar { border-left-color: #3b82f6; background: #eff6ff; }
        
        /* Teclado de Acesso */
        .key-btn { width: 72px; height: 72px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 50%; font-size: 1.5rem; font-weight: 800; color: var(--mb-brand); box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: transform 0.1s; }
        .key-btn:active { transform: scale(0.9); background-color: #f1f1f1; }
        
        /* Barras de Sala */
        .room-bar { height: 12px; background: #e2e8f0; border-radius: 6px; position: relative; min-width: 500px; border: 1px solid #cbd5e1; }
        .busy-now { position: absolute; height: 100%; background: var(--mb-brand); border-radius: 4px; }
    </style>
</head>
<body class="p-4 pb-32">

    <div id="auth-overlay" class="fixed inset-0 bg-[#990b02] z-[300] flex flex-col items-center justify-center p-6">
        <div class="text-center mb-8">
            <div class="text-white text-5xl mb-4">üîê</div>
            <h1 class="text-white text-xl font-black uppercase tracking-widest">Acesso Restrito</h1>
            <div id="pass-display" class="flex gap-4 justify-center mt-6 h-4">
                <div class="w-3 h-3 rounded-full border-2 border-white"></div>
                <div class="w-3 h-3 rounded-full border-2 border-white"></div>
                <div class="w-3 h-3 rounded-full border-2 border-white"></div>
                <div class="w-3 h-3 rounded-full border-2 border-white"></div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-6">
            <button class="key-btn" onclick="press('A')">A</button>
            <button class="key-btn" onclick="press('B')">B</button>
            <button class="key-btn" onclick="press('C')">C</button>
            <button class="key-btn" onclick="press('1')">1</button>
            <button class="key-btn" onclick="press('2')">2</button>
            <button class="key-btn" onclick="press('3')">3</button>
            <button class="key-btn" onclick="press('4')">4</button>
            <button class="key-btn" onclick="press('5')">5</button>
            <button class="key-btn" onclick="press('6')">6</button>
            <button class="key-btn" onclick="press('7')">7</button>
            <button class="key-btn" onclick="press('8')">8</button>
            <button class="key-btn" onclick="press('9')">9</button>
            <div class="flex items-center justify-center text-white/50 cursor-pointer" onclick="resetPass()">‚úï</div>
            <button class="key-btn" onclick="press('0')">0</button>
            <div class="flex items-center justify-center text-white/50 cursor-pointer" onclick="backspace()">‚å´</div>
        </div>
    </div>

    <div class="max-w-2xl mx-auto bg-white p-6 rounded-[32px] shadow-sm mb-10 border border-slate-100">
        <h2 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-[0.2em]">Ocupa√ß√£o das Salas (Hoje)</h2>
        <div class="overflow-x-auto">
            <div class="flex ml-20 mb-2" id="timeLabels"></div>
            <div class="space-y-4">
                <div class="flex items-center gap-4"><span class="text-[10px] font-black w-16 text-slate-500 uppercase">Reuni√£o</span><div class="room-bar flex-1" id="bar-Sala de Reuni√£o"></div></div>
                <div class="flex items-center gap-4"><span class="text-[10px] font-black w-16 text-slate-500 uppercase">Dire√ß√£o</span><div class="room-bar flex-1" id="bar-Sala da Dire√ß√£o"></div></div>
                <div class="flex items-center gap-4"><span class="text-[10px] font-black w-16 text-slate-500 uppercase">Aula</span><div class="room-bar flex-1" id="bar-Sala de aula"></div></div>
            </div>
        </div>
    </div>

    <div id="agenda-feed" class="max-w-2xl mx-auto space-y-6"></div>

    <button onclick="document.getElementById('createModal').classList.remove('hidden')" class="fixed bottom-8 right-8 bg-[#990b02] text-white w-16 h-16 rounded-full shadow-2xl text-4xl flex items-center justify-center z-50 active:scale-90 transition-transform">Ôºã</button>

    <div id="actionModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-end sm:items-center justify-center p-4">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-md p-8 shadow-2xl text-center">
            <h3 class="text-xl font-black text-[#990b02] mb-6">A√ß√µes do Evento</h3>
            <div class="grid gap-3">
                <button onclick="updateStatus('Confirmada')" class="bg-green-500 text-white py-4 rounded-2xl font-bold">Confirmada</button>
                <button onclick="updateStatus('No show')" class="bg-gray-600 text-white py-4 rounded-2xl font-bold">No Show</button>
                <button onclick="updateStatus('Cancelada')" class="bg-red-500 text-white py-4 rounded-2xl font-bold">Cancelada</button>
                <div class="border-t my-2"></div>
                <button onclick="deleteEvent()" class="bg-black text-white py-3 rounded-xl text-[10px] font-bold uppercase tracking-widest">Excluir para sempre</button>
                <button onclick="closeModals()" class="text-slate-400 mt-2 font-bold">Voltar</button>
            </div>
        </div>
    </div>

    <div id="createModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <form id="scheduleForm" class="space-y-4">
                <h2 class="text-2xl font-black text-[#990b02] mb-4">Agendar</h2>
                <input type="text" id="nomeAluno" placeholder="Nome do Aluno" required class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none">
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="form-data" required class="bg-slate-50 p-4 rounded-2xl border-none outline-none">
                    <input type="time" id="form-hora" required class="bg-slate-50 p-4 rounded-2xl border-none outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <select id="segmento" onchange="updateTurmas()" class="bg-slate-50 p-4 rounded-2xl border-none outline-none"><option>ECE</option><option>ELE</option><option selected>MY</option></select>
                    <select id="turma" class="bg-slate-50 p-4 rounded-2xl border-none outline-none"></select>
                </div>
                <select id="psicologa" class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none">
                    <option value="N√£o">Psic√≥loga: N√£o</option>
                    <option value="Ana L√≠dia">Ana L√≠dia</option>
                    <option value="Vanessa">Vanessa</option>
                </select>
                <select id="local" class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none">
                    <option>Sala de Reuni√£o</option><option>Sala da Dire√ß√£o</option><option>Sala de aula</option>
                </select>
                <button type="submit" class="w-full bg-[#990b02] text-white font-black py-5 rounded-2xl shadow-lg mt-2">CRIAR AGENDAMENTO</button>
                <button type="button" onclick="closeModals()" class="w-full text-slate-400 font-bold py-2">Cancelar</button>
            </form>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwM7Eq6n5OWlY8OorTMFnEFfaBBg5Wi5COGYI3vmMJvbjMo27aDVezzH97KejUJ3x6wVQ/exec';
        let currentEventId = null;
        let inputPass = "";
        let sessionHash = sessionStorage.getItem('mb_auth_hash');

        if (sessionHash) { document.getElementById('auth-overlay').classList.add('hidden'); }

        async function generateHash(string) {
            const msgUint8 = new TextEncoder().encode(string.toUpperCase()); // Garante que SENHA seja processado em corretamente
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function press(val) {
            if(inputPass.length >= 4) return;
            inputPass += val;
            updateDisplay();
            if(inputPass.length === 4) {
                const hash = await generateHash(inputPass);
                // Hash exato para SENHA
                if(hash === "858e3ca205260100466b04392477926b472855734563a94df6289d0442340578") {
                    sessionStorage.setItem('mb_auth_hash', hash);
                    sessionHash = hash;
                    document.getElementById('auth-overlay').classList.add('hidden');
                } else {
                    alert("Senha Incorreta");
                    resetPass();
                }
            }
        }

        function updateDisplay() {
            const dots = document.querySelectorAll('#pass-display div');
            dots.forEach((dot, i) => {
                if(i < inputPass.length) dot.classList.add('bg-white');
                else dot.classList.remove('bg-white');
            });
        }

        function resetPass() { inputPass = ""; updateDisplay(); }
        function backspace() { inputPass = inputPass.slice(0, -1); updateDisplay(); }

        // --- CORE FUNCTIONS ---
        async function load() {
            const feed = document.getElementById('agenda-feed');
            try {
                const res = await fetch(SCRIPT_URL);
                const events = await res.json();
                feed.innerHTML = '';
                const today = new Date();
                const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

                for(let i = 0; i < 40; i++) {
                    const d = new Date();
                    d.setDate(today.getDate() + i);
                    if(d.getDay() === 0 || d.getDay() === 6) continue;
                    const dateStr = d.toISOString().split('T')[0];
                    const dayCard = document.createElement('div');
                    dayCard.className = 'day-card p-6';
                    dayCard.innerHTML = `<div class="mb-4 border-b pb-2"><h3 class="text-xl font-black text-[#990b02]">${d.toLocaleDateString('pt-BR', {weekday:'long'}).toUpperCase()}</h3><p class="text-[10px] font-bold text-slate-400 tracking-widest">${d.getDate()} de ${monthNames[d.getMonth()]} de ${d.getFullYear()}</p></div>`;
                    
                    const dayEvents = events.filter(e => e.start.startsWith(dateStr));
                    dayEvents.sort((a,b) => a.start.localeCompare(b.start)).forEach(e => {
                        const time = new Date(e.start).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                        const statusStyle = `status-${e.status.toLowerCase().replace(" ", "")}`;
                        dayCard.innerHTML += `<div onclick="handleEventClick('${e.id}')" class="p-4 mb-3 rounded-2xl shadow-sm ${statusStyle}"><div class="flex justify-between items-center"><span class="font-black text-lg">${time}</span><span class="text-[8px] font-black uppercase opacity-40">${e.status}</span></div><div class="text-sm font-bold text-slate-700">${e.title}</div></div>`;
                    });
                    feed.appendChild(dayCard);
                }
                updateRoomVisuals(events);
            } catch(e) { feed.innerHTML = `<p class="text-center text-red-500">Erro de conex√£o com o banco de dados.</p>`; }
        }

        function handleEventClick(id) { currentEventId = id; document.getElementById('actionModal').classList.remove('hidden'); }

        async function updateStatus(s) {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', eventId: currentEventId, newStatus: s, authHash: sessionHash })});
            location.reload();
        }

        async function deleteEvent() {
            if(!confirm("Excluir este agendamento definitivamente do Google Calendar?")) return;
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', eventId: currentEventId, authHash: sessionHash })});
            location.reload();
        }

        function closeModals() { document.querySelectorAll('.fixed.inset-0:not(#auth-overlay)').forEach(m => m.classList.add('hidden')); }

        function updateRoomVisuals(events) {
            const todayStr = new Date().toISOString().split('T')[0];
            ['Sala de Reuni√£o', 'Sala da Dire√ß√£o', 'Sala de aula'].forEach(room => {
                const bar = document.getElementById(`bar-${room}`);
                if(!bar) return;
                bar.innerHTML = '';
                events.filter(e => e.start.startsWith(todayStr) && e.location === room).forEach(e => {
                    const s = new Date(e.start);
                    const eTime = new Date(e.end);
                    const left = ((s.getHours() + s.getMinutes()/60) - 7) / 11.33 * 100;
                    const width = (eTime - s) / (11.33 * 3600000) * 100;
                    bar.innerHTML += `<div class="busy-now" style="left:${left}%; width:${width}%"></div>`;
                });
            });
        }

        function updateTurmas() {
            const seg = document.getElementById('segmento').value;
            const data = { 'ECE': ['JK.M', 'JK.T', 'NUR.M', 'NUR.T', 'SK.M', 'SK.T', 'TOD.M', 'TOD.T'], 'ELE': ['Y1.M', 'Y1.T', 'Y2.M', 'Y2.T', 'Y3.M', 'Y3.T', 'Y4.M', 'Y4.T'], 'MY': ['Y6A', 'Y6B', 'Y7A', 'Y7B', 'Y8', 'Y9'] };
            document.getElementById('turma').innerHTML = data[seg].map(t => `<option>${t}</option>`).join('');
        }

        document.getElementById('scheduleForm').onsubmit = async (e) => {
            e.preventDefault();
            const p = { action: 'create', nomeAluno: document.getElementById('nomeAluno').value, start: `${document.getElementById('form-data').value}T${document.getElementById('form-hora').value}:00`, turma: document.getElementById('turma').value, segmento: document.getElementById('segmento').value, psicologa: document.getElementById('psicologa').value, local: document.getElementById('local').value };
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(p) });
            location.reload();
        };

        for(let i=7;i<=18;i++) document.getElementById('timeLabels').innerHTML += `<span class="min-w-[40px] text-[10px] text-slate-300 font-bold">${i}h</span>`;
        updateTurmas();
        load();
    </script>
</body>
</html>
