<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maple Bear - Agenda Middle Years</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mb-blue: #004a99; --mb-red: #e30613; }
        body { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; }
        
        /* Estilo dos Cards de Dia */
        .day-card { background: white; border-radius: 24px; border-left: 10px solid var(--mb-blue); margin-bottom: 2rem; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); }
        
        /* Cores de Status baseadas no Google Calendar */
        .status-confirmada { border-left-color: #22c55e; background: #f0fdf4; } /* Verde Basil */
        .status-noshow { border-left-color: #4b5563; background: #f3f4f6; }    /* Grafite */
        .status-cancelada { border-left-color: #ef4444; background: #fef2f2; } /* Vermelho Tomato */
        .status-aconfirmar { border-left-color: #3b82f6; background: #eff6ff; } /* Azul padrão */
        
        /* Timeline de Ocupação */
        .room-bar { height: 12px; background: #f1f5f9; border-radius: 6px; position: relative; min-width: 500px; border: 1px solid #e2e8f0; }
        .busy-now { position: absolute; height: 100%; background: var(--mb-red); border-radius: 4px; }
        
        /* Ajuste para scroll suave */
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-slate-50 p-4 pb-32">

    <div class="max-w-2xl mx-auto bg-white p-6 rounded-[32px] shadow-sm mb-10 border border-slate-100">
        <h2 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-[0.2em]">Ocupação das Salas (Hoje)</h2>
        <div class="overflow-x-auto">
            <div class="flex ml-20 mb-2" id="timeLabels"></div>
            <div class="space-y-4">
                <div class="flex items-center gap-4"><span class="text-[10px] font-black w-16 text-slate-500 uppercase">Reunião</span><div class="room-bar flex-1" id="bar-Sala de Reunião"></div></div>
                <div class="flex items-center gap-4"><span class="text-[10px] font-black w-16 text-slate-500 uppercase">Direção</span><div class="room-bar flex-1" id="bar-Sala da Direção"></div></div>
                <div class="flex items-center gap-4"><span class="text-[10px] font-black w-16 text-slate-500 uppercase">Aula</span><div class="room-bar flex-1" id="bar-Sala de aula"></div></div>
            </div>
        </div>
    </div>

    <div id="agenda-feed" class="max-w-2xl mx-auto space-y-6">
        <div class="text-center py-20">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-900 mx-auto mb-4"></div>
            <p class="text-gray-400 font-medium">Sincronizando agenda...</p>
        </div>
    </div>

    <button onclick="document.getElementById('createModal').classList.remove('hidden')" class="fixed bottom-8 right-8 bg-blue-900 text-white w-16 h-16 rounded-full shadow-2xl text-4xl flex items-center justify-center z-50 active:scale-90 transition-transform">＋</button>

    <div id="actionModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-end sm:items-center justify-center p-4">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-md p-8 shadow-2xl text-center">
            <h3 class="text-xl font-black text-blue-900 mb-6">Gerenciar Agendamento</h3>
            <div class="grid gap-3">
                <button onclick="updateStatus('Confirmada')" class="bg-green-500 text-white py-4 rounded-2xl font-bold shadow-sm">Confirmada (Verde)</button>
                <button onclick="updateStatus('No show')" class="bg-gray-600 text-white py-4 rounded-2xl font-bold shadow-sm">No Show (Cinza)</button>
                <button onclick="updateStatus('Cancelada')" class="bg-red-400 text-white py-4 rounded-2xl font-bold shadow-sm">Cancelada (Vermelho)</button>
                <div class="border-t my-2"></div>
                <button onclick="deleteEvent()" class="bg-red-800 text-white py-3 rounded-xl text-[10px] font-bold uppercase tracking-widest">Excluir do Google Calendar</button>
                <button onclick="closeModals()" class="text-slate-400 mt-2 font-bold">Voltar</button>
            </div>
        </div>
    </div>

    <div id="createModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto shadow-2xl">
            <form id="scheduleForm" class="space-y-4">
                <h2 class="text-2xl font-black text-blue-900 mb-4">Novo Agendamento</h2>
                <input type="text" id="nomeAluno" placeholder="Nome do Aluno" required class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-900">
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="form-data" required class="bg-slate-50 p-4 rounded-2xl border-none outline-none">
                    <input type="time" id="form-hora" required class="bg-slate-50 p-4 rounded-2xl border-none outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <select id="segmento" onchange="updateTurmas()" class="bg-slate-50 p-4 rounded-2xl border-none outline-none"><option>ECE</option><option>ELE</option><option selected>MY</option></select>
                    <select id="turma" class="bg-slate-50 p-4 rounded-2xl border-none outline-none"></select>
                </div>
                <select id="psicologa" class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none">
                    <option value="Não">Psicóloga: Não</option>
                    <option value="Ana Lídia">Ana Lídia</option>
                    <option value="Vanessa">Vanessa</option>
                </select>
                <select id="local" class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none">
                    <option>Sala de Reunião</option>
                    <option>Sala da Direção</option>
                    <option>Sala de aula</option>
                </select>
                <button type="submit" class="w-full bg-blue-900 text-white font-black py-5 rounded-2xl shadow-lg mt-2">AGENDAR REUNIÃO</button>
                <button type="button" onclick="closeModals()" class="w-full text-slate-400 font-bold py-2">Cancelar</button>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwYdqHGsIoUddXHiH_N90Q936Bo2rbWKdDXhxIeuRXYomduBbJ9VMNbob_4xCCxJaghaQ/exec';
        let currentEventId = null;
        let sessionHash = null; // Armazena o hash da senha durante a sessão

        // --- SEGURANÇA (HASHING) ---
        async function generateHash(string) {
            const msgUint8 = new TextEncoder().encode(string);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- CARREGAMENTO DE DADOS ---
        async function load() {
            const feed = document.getElementById('agenda-feed');
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error('Falha na conexão');
                const events = await response.json();
                
                feed.innerHTML = '';
                const today = new Date();
                const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

                // Renderiza próximos 40 dias (pulando fins de semana)
                for(let i = 0; i < 40; i++) {
                    const d = new Date();
                    d.setDate(today.getDate() + i);
                    if(d.getDay() === 0 || d.getDay() === 6) continue;

                    const dateStr = d.toISOString().split('T')[0];
                    const dayName = d.toLocaleDateString('pt-BR', {weekday: 'long'}).toUpperCase();
                    const fullDateDisplay = `${d.getDate()} de ${monthNames[d.getMonth()]} de ${d.getFullYear()}`;

                    const dayCard = document.createElement('div');
                    dayCard.className = 'day-card p-6';
                    dayCard.innerHTML = `
                        <div class="mb-6 border-b border-slate-50 pb-2">
                            <h3 class="text-xl font-black text-blue-900">${dayName}</h3>
                            <p class="text-[10px] font-bold text-slate-400 tracking-widest">${fullDateDisplay}</p>
                        </div>`;

                    const dayEvents = events.filter(e => e.start.startsWith(dateStr));
                    
                    if(dayEvents.length === 0) {
                        dayCard.innerHTML += `<p class="text-slate-200 text-[10px] font-black uppercase py-2">Sem agendamentos</p>`;
                    } else {
                        dayEvents.sort((a,b) => a.start.localeCompare(b.start)).forEach(e => {
                            const time = new Date(e.start).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                            const statusStyle = `status-${e.status.toLowerCase().replace(" ", "")}`;
                            dayCard.innerHTML += `
                                <div onclick="handleEventClick('${e.id}')" class="p-4 mb-3 rounded-2xl cursor-pointer shadow-sm transition-all active:scale-95 ${statusStyle}">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-black text-lg">${time}</span>
                                        <span class="text-[8px] font-black uppercase opacity-40">${e.status}</span>
                                    </div>
                                    <div class="text-sm font-bold text-slate-700">${e.title}</div>
                                </div>`;
                        });
                    }
                    feed.appendChild(dayCard);
                }
                updateRoomVisuals(events);
            } catch(e) {
                feed.innerHTML = `<div class="bg-red-50 p-8 rounded-3xl text-red-600 text-center font-bold">Erro ao carregar agenda.</div>`;
            }
        }

        // --- AÇÕES ---
        async function handleEventClick(id) {
            if (!sessionHash) {
                const pwd = prompt("Senha de Coordenador:");
                if (!pwd) return;
                sessionHash = await generateHash(pwd);
            }
            currentEventId = id;
            document.getElementById('actionModal').classList.remove('hidden');
        }

        async function updateStatus(s) {
            const res = await fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'updateStatus', eventId: currentEventId, newStatus: s, authHash: sessionHash })
            });
            const result = await res.json();
            if (result.success) location.reload();
            else { alert("Não autorizado"); sessionHash = null; }
        }

        async function deleteEvent() {
            if(!confirm("Deseja excluir este evento do Google Calendar definitivamente?")) return;
            const res = await fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'delete', eventId: currentEventId, authHash: sessionHash })
            });
            const result = await res.json();
            if (result.success) location.reload();
            else { alert("Não autorizado"); sessionHash = null; }
        }

        // --- UTILITÁRIOS ---
        function closeModals() {
            document.getElementById('actionModal').classList.add('hidden');
            document.getElementById('createModal').classList.add('hidden');
        }

        function updateRoomVisuals(events) {
            const todayStr = new Date().toISOString().split('T')[0];
            ['Sala de Reunião', 'Sala da Direção', 'Sala de aula'].forEach(room => {
                const bar = document.getElementById(`bar-${room}`);
                if(!bar) return;
                bar.innerHTML = '';
                events.filter(e => e.start.startsWith(todayStr) && e.location === room).forEach(e => {
                    const s = new Date(e.start);
                    const eTime = new Date(e.end);
                    const left = ((s.getHours() + s.getMinutes()/60) - 7) / 11.33 * 100;
                    const width = (eTime - s) / (11.33 * 3600000) * 100;
                    bar.innerHTML += `<div class="busy-now" style="left:${left}%; width:${width}%"></div>`;
                });
            });
        }

        function updateTurmas() {
            const seg = document.getElementById('segmento').value;
            const data = { 
                'ECE': ['JK.M', 'JK.T', 'NUR.M', 'NUR.T', 'SK.M', 'SK.T', 'TOD.M', 'TOD.T'], 
                'ELE': ['Y1.M', 'Y1.T', 'Y2.M', 'Y2.T', 'Y3.M', 'Y3.T', 'Y4.M', 'Y4.T'], 
                'MY': ['Y6A', 'Y6B', 'Y7A', 'Y7B', 'Y8', 'Y9'] 
            };
            document.getElementById('turma').innerHTML = data[seg].map(t => `<option>${t}</option>`).join('');
        }

        // --- SUBMISSÃO ---
        document.getElementById('scheduleForm').onsubmit = async (e) => {
            e.preventDefault();
            const p = {
                action: 'create',
                nomeAluno: document.getElementById('nomeAluno').value,
                start: `${document.getElementById('form-data').value}T${document.getElementById('form-hora').value}:00`,
                turma: document.getElementById('turma').value,
                segmento: document.getElementById('segmento').value,
                psicologa: document.getElementById('psicologa').value,
                local: document.getElementById('local').value
            };
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(p) });
            location.reload();
        };

        // --- INICIALIZAÇÃO ---
        for(let i=7;i<=18;i++) document.getElementById('timeLabels').innerHTML += `<span class="min-w-[40px] text-[10px] text-slate-300 font-bold">${i}h</span>`;
        updateTurmas();
        load();
    </script>
</body>
</html>
